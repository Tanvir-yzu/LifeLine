{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard - LifeLine Blood Bank{% endblock %}

{% block content %}
<div x-data="dashboard()" class="bg-gradient-to-br from-red-50 to-pink-50 min-h-screen py-8">
    <div class="container mx-auto px-4">
        <!-- Welcome Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Welcome back, {{ user.first_name|default:user.username }}!</h1>
                    <p class="text-gray-600 mt-2">Your dashboard for blood donation activities.</p>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-red-600">{{ user.blood_group|default:'N/A' }}</div>
                        <div class="text-sm text-gray-500 font-medium">Blood Type</div>
                    </div>
                    {% if user.is_donor %}
                    <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        Active Donor
                    </span>
                    {% else %}
                    <a href="{% url 'users:profile_edit' %}" class="bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-blue-600 transition-colors">
                        Become a Donor
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            {% include 'users/dashboard_stats_cards.html' %}
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Activity Chart -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">My Activity Overview</h2>
                    <div class="h-64">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <!-- Tabbed Section for Requests and Donations -->
                <div class="bg-white rounded-lg shadow-lg">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                            <button @click="activeTab = 'my-requests'" :class="activeTab === 'my-requests' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                My Requests
                            </button>
                            <button @click="activeTab = 'my-donations'" :class="activeTab === 'my-donations' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                My Donations
                            </button>
                            <button @click="activeTab = 'available-requests'" :class="activeTab === 'available-requests' ? 'border-red-500 text-red-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                                Available Requests
                            </button>
                        </nav>
                    </div>
                    <div class="p-6">
                        <div x-show="activeTab === 'my-requests'">
                            {% include 'users/dashboard_my_requests.html' %}
                        </div>
                        <div x-show="activeTab === 'my-donations'">
                            {% include 'users/dashboard_my_donations.html' %}
                        </div>
                        <div x-show="activeTab === 'available-requests'">
                            {% include 'users/dashboard_available_requests.html' %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <!-- Profile Card -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">My Profile</h2>
                    {% include 'users/dashboard_profile_card.html' %}
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <a href="{% url 'users:profile_edit' %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            Edit Profile
                        </a>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Quick Actions</h2>
                    <div class="space-y-3">
                        <a href="{% url 'users:blood_request_create' %}" class="block w-full bg-red-600 text-white text-center py-2.5 px-4 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            Create Blood Request
                        </a>
                        <a href="{% url 'users:find_donors' %}" class="block w-full bg-green-600 text-white text-center py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            Find Donors
                        </a>
                        <a href="{% url 'users:blood_request_list' %}" class="block w-full bg-blue-600 text-white text-center py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            Browse All Requests
                        </a>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Activity</h2>
                    {% if recent_responses %}
                        <div class="space-y-4">
                            {% for response in recent_responses|slice:":5" %}
                            <div class="flex items-start text-sm">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 000 3h.5a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-.5a1.5 1.5 0 00-3 0v.5a1 1 0 01-1 1H6a1 1 0 01-1-1v-3a1 1 0 00-1-1h-.5a1.5 1.5 0 010-3H4a1 1 0 001-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z"></path></svg>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <p class="text-gray-900 font-medium">
                                        You responded to a request for
                                        <span class="font-bold text-red-600">{{ response.blood_request.blood_type }}</span> blood.
                                    </p>
                                    <p class="text-gray-500">{{ response.created_at|naturaltime }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-500">No recent donation activity.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    function dashboard() {
        return {
            activeTab: 'my-requests',
            init() {
                this.initChart();
            },
            initChart() {
                const ctx = document.getElementById('activityChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['My Requests', 'My Donations', 'Fulfilled', 'Pending'],
                        datasets: [{
                            label: 'Activity Count',
                            data: [
                                {{ total_requests|default:0 }},
                                {{ total_responses|default:0 }},
                                {{ fulfilled_requests|default:0 }},
                                {{ pending_requests|default:0 }}
                            ],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.5)',
                                'rgba(34, 197, 94, 0.5)',
                                'rgba(16, 185, 129, 0.5)',
                                'rgba(245, 158, 11, 0.5)'
                            ],
                            borderColor: [
                                'rgba(59, 130, 246, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(16, 185, 129, 1)',
                                'rgba(245, 158, 11, 1)'
                            ],
                            borderWidth: 1,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
    }
</script>
{% endblock %}